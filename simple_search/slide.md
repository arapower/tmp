# 全文検索エンジンのしくみ

## 内容

### 説明

具体例を使って直感的にわかる説明

- 全文検索エンジンって何？
  - 必要なの？
- 全文検索エンジンの仕組み

### 実演

テキストファイルとシェルコマンドでライブコーディング

- 検索準備スクリプト（インデックス生成スクリプト）
- 検索実行スクリプト

## 全文検索エンジンって何？

検索対象としたい文書内すべての文章を検索するソフトウェア

### 分類

- インデックス型
  - Google（Webサイト）
  - Amazon（販売ページ）
- 逐次検索型
  - Word、Excel（Officeファイル）

検索のためのインデックス（索引）を用意しておくインデックス型の方が検索速度が速い
（索引のイメージ画像を貼る）

## 全文検索エンジン（インデックス型）の種類

1. 形態素解析
   - 特徴: 単語単位にインデックスを生成
   - メリット: データ量が比較的少なく、その分検索が早い
   - デメリット: 検索漏れが起きやすい
1. N-Gram
   - 特徴: 文字単位にインデックスを生成
   - メリット: 検索精度の高さ
   - デメリット: データ量が比較的多い。検索ノイズが起きる
     - 検索ノイズの例…「かばん」の中には「かば」がいる

## N-Gramとは

文字を一定の文字数ごとに分割して転置インデックスを生成する手法

### N-Gram（2文字分割）の具体例

（ここは表にする）

| 文字の位置　　 |  １２３４５６ |
| 検索対象の文字 |  アイエンター |

↓インデックス（転置インデックス）を生成

| 文字の位置 | 文字の組み合わせ |
|:--:|:--:|
| 1 | アイ |
| 2 | イエ |
| 3 | エン |
| 4 | ンタ |
| 5 | ター |

## 検索処理の流れ

1. 検索キーワードを受け取る
1. 検索キーワードを2文字ごとに分解する
1. 各文字の組み合わせのインデックスデータを突き合わせる
1. すべての文字の組み合わせを持つファイルが検索キーワードが含まれる文書と判定
   - 完全一致検索

## 具体例で「インデックス生成～検索処理」の流れ

文書1 ここはアイエンターです
文書2 これはエンターキーです

↓インデックス生成

### 文書1

| 文字の位置 | 文字の組み合わせ |
|:--:|:--:|
| 1 | ここ |
| 2 | こは |
| 3 | はア |
| 4 | アイ |
| 5 | イエ |
| 6 | エン |
| 7 | ンタ |
| 8 | ター |
| 9 | ーで |
| 10 | です |

### 文書2

| 文字の位置 | 文字の組み合わせ |
|:--:|:--:|
| 1 | これ |
| 2 | れは |
| 3 | はエ |
| 4 | エン |
| 5 | ンタ |
| 6 | ター |
| 7 | ーキ |
| 8 | キー |
| 9 | ーで |
| 10 | です |

## 文字の組み合わせごとにまとめる

| 文字の組み合わせ | <文書ID:文字の位置> |
|:--:|:--:|
| ここ | 1:1 |
| これ | 2:1 |
| こは | 1:2 |
| れは | 2:2 |
| はア | 1:3 |
| はエ | 2:3 |
| アイ | 1:4 |
| イエ | 1:5 |
| エン | 1:6, 2:4 |
| ンタ | 1:7, 2:5 |
| ター | 1:8, 2:6 |
| ーキ | 2:7 |
| キー | 2:8 |
| ーで | 1:9, 2:9 |
| です | 1:10, 2:10 |

インデックスデータの準備完了

## 検索する

1. 検索キーワードを受け取る
   - 検索キーワード: アイエンター
1. 検索キーワードを2文字ごとに分解する

| アイ |
| イエ |
| エン |
| ンタ |
| ター |

1. 文字の組み合わせのインデックスデータを取得する

| 文字の組み合わせ | <文書ID:文字の位置> |
|:--:|:--:|
| アイ | 1:4 |
| イエ | 1:5 |
| エン | 1:6, 2:4 |
| ンタ | 1:7, 2:5 |
| ター | 1:8, 2:6 |

1. 各文字の組み合わせのインデックスデータを突き合わせる
   - インデックスデータを文書IDごとにまとめる

| 文書ID | 文字の位置 |
|:--:|:--:|
| 1 | 4, 5, 6, 7, 8 |
| 2 | 4, 5, 6 |

1. すべての文字の組み合わせを持つファイルが検索キーワードが含まれる文書と判定
   - （完全一致検索）

**文書ID1が検索キーワードに合致する**

## 転置インデックスを利用した検索の速さの理由

- 検索時に扱うデータは検索キーワードの文字数分のインデックスデータ
  - 今回は5つの文字の組み合わせのデータ
- 逐次検索型の場合は検索対象ファイルすべてを見なければいけない

## 実演時に以下の単語を説明

- オフセット…先頭からの文字の位置
- ターム…転置インデックス生成時の文字の組み合わせ

